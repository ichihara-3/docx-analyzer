<!doctype html>
<html lang="ja">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>DOCX Analyzer</title>
  <link rel="stylesheet" href="/static/css/style.css" />
</head>

<body>
  <div class="container">
    <h1>DOCX Analyzer</h1>
    <p class="notice">
      📄 DOCX をアップロードすると、段落解析と LLM レビューを実行します。<br>
      対応ファイル: .docx（最大10MB）
    </p>

    {% if error %}
    <div class="error">
      <div class="error-title">❌ エラーが発生しました</div>
      <p>{{ error }}</p>

      {% if error_type == 'file_too_large' %}
      <div class="error-solutions">
        <strong>対処方法:</strong>
        <ul>
          <li>ファイルサイズを10MB以下に削減してください</li>
          <li>不要な画像や埋め込みオブジェクトを削除してください</li>
          <li>ファイルを複数に分割することを検討してください</li>
        </ul>
      </div>
      {% elif error_type == 'invalid_file_type' %}
      <div class="error-solutions">
        <strong>対処方法:</strong>
        <ul>
          <li>ファイルの拡張子が .docx であることを確認してください</li>
          <li>.doc ファイルの場合は、Wordで開いて .docx 形式で保存し直してください</li>
        </ul>
      </div>
      {% elif error_type == 'parse_error' %}
      <div class="error-solutions">
        <strong>対処方法:</strong>
        <ul>
          <li>ファイルをWordで開いて再保存してください</li>
          <li>別のDOCXファイルで試してください</li>
          <li>ファイルが破損していないか確認してください</li>
        </ul>
      </div>
      {% elif error_type == 'llm_error' %}
      <div class="error-solutions">
        <strong>対処方法:</strong>
        <ul>
          <li>GOOGLE_API_KEY が正しく設定されているか確認してください</li>
          <li>APIキーの利用制限に達していないか確認してください</li>
          <li>しばらく時間をおいて再試行してください</li>
        </ul>
      </div>
      {% endif %}

      <button type="button" onclick="window.location.reload()" style="margin-top: 12px;">
        🔄 もう一度試す
      </button>
    </div>
    {% endif %}

    <!-- Loading overlay -->
    <div id="loadingOverlay" class="loading-overlay">
      <div class="loading-content">
        <div class="spinner"></div>
        <div class="loading-text">処理中...</div>
        <div class="loading-subtext">
          DOCXファイルを解析し、LLMレビューを実行しています。<br>
          しばらくお待ちください。
        </div>
      </div>
    </div>

    <form action="/analyze" method="post" enctype="multipart/form-data" id="analyzeForm">
      <div>
        <label for="file">DOCX ファイル</label>
        <div class="drop-zone" id="dropZone">
          <div class="drop-zone-icon">📄</div>
          <div class="drop-zone-text">ファイルをドラッグ&ドロップ</div>
          <div class="drop-zone-text">または</div>
          <input id="file" name="file" type="file" accept=".docx" required style="display: none;" />
          <button type="button" onclick="document.getElementById('file').click()" class="secondary">
            ファイルを選択
          </button>
        </div>
        <div id="fileInfo" class="file-info"></div>
      </div>

      <div>
        <label for="model">モデル</label>
        <select id="model" name="model">
          <option value="gemini-3.0-pro" {% if default_model=='gemini-3.0-pro' %}selected{% endif %}>gemini 3.0 pro
          </option>
          <option value="gemini-2.5-pro" {% if default_model=='gemini-2.5-pro' %}selected{% endif %}>gemini 2.5 pro
          </option>
          <option value="gemini-2.5-flash" {% if default_model=='gemini-2.5-flash' %}selected{% endif %}>gemini 2.5
            flash</option>
        </select>
      </div>

      <div class="template-group">
        <label for="template">レビュータイプ</label>
        <select id="template" name="template">
          <option value="default" {% if default_template=='default' %}selected{% endif %}>デフォルト（契約レビュー）</option>
          <option value="risk_focus" {% if default_template=='risk_focus' %}selected{% endif %}>リスク重点レビュー</option>
          <option value="change_summary" {% if default_template=='change_summary' %}selected{% endif %}>変更履歴サマリー
          </option>
          <option value="comment_review" {% if default_template=='comment_review' %}selected{% endif %}>コメント対応チェック
          </option>
          <option value="custom" {% if default_template=='custom' %}selected{% endif %}>カスタム</option>
        </select>
        <div class="template-info" id="templateInfo">
          リスクのある条項、追跡変更、コメントを総合的にレビューします
        </div>
      </div>

      <div class="custom-prompt-area" id="customPromptArea">
        <label for="prompt">カスタムレビュー指示</label>
        <textarea id="prompt" name="prompt" style="min-height: 150px;">{{ default_prompt or "" }}</textarea>
      </div>

      <button type="submit">🔍 解析 & レビュー</button>
    </form>

    {% if result %}
    <div class="result-section">
      <h3>📊 処理結果</h3>
      <div style="margin-bottom: 16px;">
        <span class="info-badge">📁 {{ result.filename }}</span>
        <span class="info-badge">📏 {{ result.file_size }} KB</span>
        <span class="info-badge">⏱️ {{ result.processing_time }} 秒</span>
        <span class="info-badge">🤖 {{ result.model }}</span>
      </div>
    </div>

    <div class="result-section">
      <details>
        <summary style="cursor: pointer; font-weight: bold; margin-bottom: 8px;">解析結果 (JSON)</summary>
        <div class="result-actions">
          <button type="button" class="secondary" onclick="copyToClipboard('analysisJson')">
            📋 JSONをコピー
          </button>
          <button type="button" class="secondary" onclick="downloadJson()">
            💾 JSONをダウンロード
          </button>
        </div>
        <pre id="analysisJson">{{ result.analysis_json }}</pre>
      </details>
    </div>

    <div class="result-section">
      <h3>✨ LLM レビュー</h3>
      <div class="result-actions">
        <button type="button" class="secondary" onclick="copyToClipboard('reviewContent')">
          📋 レビューをコピー
        </button>
        <button type="button" class="secondary" onclick="downloadMarkdown()">
          💾 Markdownをダウンロード
        </button>
      </div>
      <div class="markdown-body" id="reviewContent">
        {{ result.review_html | safe }}
      </div>
    </div>
    {% endif %}
  </div>

  <script src="/static/js/main.js"></script>
</body>

</html>